# Auto-attach to tmux when running inside Ghostty (not already in tmux)
if [[ "$TERM_PROGRAM" == "ghostty" ]] && [[ -z "$TMUX" ]]; then
  exec tmux new-session -A -s main
fi

# History settings (must be set before autosuggestions plugin)
HISTFILE=~/.zhistory
HISTSIZE=65535
SAVEHIST=1000000000
setopt hist_ignore_all_dups hist_ignore_dups inc_append_history share_history EXTENDED_HISTORY

# Set fpath before compinit (Nix completions + custom completions)
fpath=(
  "$HOME/.nix-profile/share/zsh/site-functions"
  "${XDG_DATA_HOME:-$HOME/.local/share}/zsh/completions"
  $fpath
)

# Load plugin manager (compinit is handled by sheldon hooks)
if command -v sheldon &>/dev/null; then
  eval "$(sheldon source)"
fi

# Load ubuntu related configurations
uname -v | grep -q "Ubuntu"
ubuntu=$?

if [ ${ubuntu} = 0 ]; then
  for zsh_source in $HOME/.zsh/configs/ubuntu/*.zsh; do
    source $zsh_source
  done
fi

# Load wsl(ubuntu) related configuration
uname -v | grep -q "Microsoft"
wsl=$?

if [ ${wsl} = 0 ]; then
  for zsh_source in $HOME/.zsh/configs/wsl/*.zsh; do
    source $zsh_source
  done

  # Set umask 022 only if it's wsl
  umask 022
fi

# Load osx related configurations

if [ "$(uname)" = 'Darwin' ]; then
  for zsh_source in $HOME/.zsh/configs/darwin/*.zsh; do
    source $zsh_source
  done
fi

# load custom configurations
for zsh_source in $HOME/.zsh/configs/*.zsh; do
  source $zsh_source
done

[[ -f $HOME/.zsh_aliases ]] && source $HOME/.zsh_aliases

[[ -f $HOME/.zsh_aliases.local ]] && source $HOME/.zsh_aliases.local

# load functions
for zsh_source in $HOME/.zsh/functions/*.zsh; do
  source $zsh_source
done

# Ensure nix-installed tools take priority (must be last)
[ -d "$HOME/.nix-profile/bin" ] && export PATH="$HOME/.nix-profile/bin:$PATH"
